#!/bin/bash

normal=$(tput sgr0)
yellow=$(tput setaf 3)
red=$(tput setaf 1)

delete_remote_files () {
    filelist=$(echo "$2" | rsync -ntii --files-from=- --remove-source-files "$host":"\$REMOTEROOT/$USER@$HOSTNAME/" "$HOME" | sed -n 's,^.f          ,,p')
    { echo "${yellow}Los siguientes archivos $1 serán borrados de $host:${normal}"; echo "$filelist"; } | less -FXr
    while true; do
        read -p "${yellow}Escriba \"ok\" para proceder o presione ENTER para cancelar: ${normal}" answer
        case "$answer" in
          [oO][kK])
            echo -n ${yellow}Borrando los archivos $1... ${normal}
            echo "$2" | rsync -tv --files-from=- --remove-source-files "$host":"\$REMOTEROOT/$USER@$HOSTNAME/" "$HOME" | sed -n 's,^.f          ,,p'
            echo Hecho
            break;;
          ?*) echo Escriba \"ok\" si desea borrar los archivos o presione ENTER para cancelar;;
          *) break;;
        esac
    done
}

options=$(getopt -n "$0" -o '' -l force,delete,exclude: -- "$@") || exit

eval "set -- $options"

while (( $# )); do
  case "$1" in
    --force) force=; shift;;
    --delete) delete=; shift;;
    --exclude) expat=$2; shift 2;;
    --) shift; break;;
     *) echo Unknown option: $1; exit 1
  esac
done

if [[ -n $1 ]]; then
    host=$1
else
    echo 'Error: Debe especificar un servidor'
    echo "Uso: $(basename "$0") <hostname>"
    exit
fi

including=$(rsync -rntii --exclude='.*' ${expat:+--exclude="$expat"} "$host":"\$REMOTEROOT/$USER@$HOSTNAME/" "$HOME")
excluding=$(rsync -rntii ${expat:+--include="$expat"} --include='*/' --exclude='*' "$host":"\$REMOTEROOT/$USER@$HOSTNAME/" "$HOME")
synced=$(echo "$including$excluding" | sed -n 's,^.f          ,,p')
unsynced=$(echo "$including" | sed -n 's,^>f+++++++++ ,,p')
excluded=$(echo "$excluding" | sed -n 's,^>f+++++++++ ,,p')
conflicting=$(echo "$including" | grep -v '^>f          ' | grep -v '^>f+++++++++ ' | sed -n 's,^>f......... ,,p')

#echo "$including"
#echo "$synced"
#echo "$unsynced"
#echo "$excluded"
#echo "$conflicting"
#exit

if [[ -n $unsynced || -n $conflicting ]]; then
    if [[ -n ${delete+?} ]]; then 
        echo ${red}No se borró ningún archivo porque hay archivos pendientes de sincronizar en pandiyan${normal}
    else
        if [[ -n $unsynced ]]; then
            echo ${yellow}Sincronizando archivos nuevos...${normal}
            echo "$unsynced" | rsync -ztvh --partial-dir=.rsynctmp --progress --files-from=- "$host":"\$REMOTEROOT/$USER@$HOSTNAME/" "$HOME"
            echo
        fi
        if [[ -n $conflicting ]]; then
            if [[ -z ${force+?} ]]; then
                echo "${yellow}La versión remota de los siguientes archivos difiere de la versión local:${normal}"
                echo "$conflicting"
                echo "${yellow}Ejecute este escript con la opción --force para sobreescribir las versiones locales${normal}"
            else
                echo ${yellow}Sobreescribiendo los archivos conflictivos...${normal}
                echo "$conflicting" | rsync -ztvh --partial-dir=.rsynctmp --progress --files-from=- "$host":"\$REMOTEROOT/$USER@$HOSTNAME/" "$HOME"
            fi
        fi
    fi
else
    if [[ -n ${delete+?} ]]; then 
        if [[ -n $synced ]]; then
            delete_remote_files "redundantes" "$synced"
        elif [[ -n $excluded ]]; then
            delete_remote_files "excluidos" "$synced"
        fi
    else
        if [[ -n $synced ]]; then
            echo "${yellow}Hay archivos redundantes en $host que ya fueron sincronizados, use la opción --delete para eliminarlos${normal}"
        fi
        if [[ -n $excluded ]]; then
            echo "${yellow}Hay archivos en $host que fueron excluidos, use las opciones --exclude=$expat y --delete para eliminarlos${normal}"
        fi
        echo No hay archivos nuevos que sincronizar
    fi
fi


